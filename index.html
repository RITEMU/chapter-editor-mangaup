<!DOCTYPE html><html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پردازشگر تصاویر</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
:root {
--primary: #2563eb;
--primary-hover: #1d4ed8;
--bg: #f8fafc;
--surface: #ffffff;
--border: #e2e8f0;
--text: #1e293b;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: system-ui, -apple-system, sans-serif;
}

body {
background: var(--bg);
color: var(--text);
line-height: 1.5;
padding: 2rem;
}

.container {
max-width: 1200px;
margin: 0 auto;
background: var(--surface);
padding: 2rem;
border-radius: 1rem;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.title {
font-size: 1.5rem;
font-weight: 700;
margin-bottom: 2rem;
text-align: center;
}

.form-group {
margin-bottom: 1.5rem;
}

.form-label {
display: block;
margin-bottom: 0.5rem;
font-weight: 500;
}

.form-control {
width: 100%;
padding: 0.75rem;
border: 1px solid var(--border);
border-radius: 0.5rem;
font-size: 1rem;
}

.btn {
background: var(--primary);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 0.5rem;
font-size: 1rem;
cursor: pointer;
transition: background 0.2s;
}

.btn:hover {
background: var(--primary-hover);
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.file-list {
border: 1px solid var(--border);
border-radius: 0.5rem;
padding: 1rem;
margin-top: 1rem;
max-height: 300px;
overflow-y: auto;
}

.file-group {
margin-bottom: 1rem;
padding-right: 1rem;
}

.file-group-title {
font-weight: 600;
margin-bottom: 0.5rem;
}

.file-item {
padding-right: 1rem;
margin-bottom: 0.25rem;
cursor: move;
}

.progress-container {
margin-top: 1rem;
display: none;
}

.progress-bar {
width: 100%;
height: 0.5rem;
background: var(--border);
border-radius: 0.25rem;
overflow: hidden;
}

.progress-fill {
height: 100%;
background: var(--primary);
width: 0%;
transition: width 0.2s;
}

.progress-text {
text-align: center;
margin-top: 0.5rem;
font-size: 0.875rem;
}

@media (max-width: 768px) {
body {
padding: 1rem;
}

.container {
padding: 1rem;
}
}
</style>
</head>
<body>
<div class="container">
<h1 class="title">پردازشگر تصاویر</h1>

<div class="form-group">
<label class="form-label">انتخاب پوشه‌ها</label>
<input type="file" class="form-control" id="fileInput" webkitdirectory multiple accept="image/*">
</div>

<div class="form-group">
<label class="form-control">
<input type="checkbox" id="mergeCheck" checked>
چسباندن تصاویر
</label>
</div>

<div id="dimensionControls">
<div class="form-group">
<label class="form-label">عرض (پیکسل)</label>
<input type="number" class="form-control" id="widthInput" value="800" min="1">
</div>

<div class="form-group">
<label class="form-label">حداکثر طول (پیکسل)</label>
<input type="number" class="form-control" id="heightInput" value="12000" min="1">
</div>
</div>

<div class="form-group">
<label class="form-label">فرمت خروجی</label>
<select class="form-control" id="formatSelect">
<option value="webp">WebP</option>
<option value="jpeg">JPEG</option>
<option value="png">PNG</option>
</select>
</div>

<div class="form-group">
<label class="form-label">کیفیت (%)</label>
<input type="number" class="form-control" id="qualityInput" value="100" min="1" max="100">
</div>

<div id="fileList" class="file-list"></div>

<button id="processBtn" class="btn" disabled>شروع پردازش</button>

<div class="progress-container" id="progressContainer">
<div class="progress-bar">
<div class="progress-fill" id="progressBar"></div>
</div>
<div class="progress-text" id="progressText">0%</div>
</div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const mergeCheck = document.getElementById('mergeCheck');
const widthInput = document.getElementById('widthInput');
const heightInput = document.getElementById('heightInput');
const formatSelect = document.getElementById('formatSelect');
const qualityInput = document.getElementById('qualityInput');
const fileList = document.getElementById('fileList');
const processBtn = document.getElementById('processBtn');
const dimensionControls = document.getElementById('dimensionControls');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

let files = {};

mergeCheck.addEventListener('change', () => {
dimensionControls.style.display = mergeCheck.checked ? 'block' : 'none';
});

fileInput.addEventListener('change', () => {
files = {};
fileList.innerHTML = '';

Array.from(fileInput.files).forEach(file => {
if (!file.type.startsWith('image/')) return;

const folderPath = file.webkitRelativePath.split('/')[0];
if (!files[folderPath]) {
files[folderPath] = [];
}
files[folderPath].push(file);
});

for (const [folder, folderFiles] of Object.entries(files)) {
const folderDiv = document.createElement('div');
folderDiv.className = 'file-group';
folderDiv.innerHTML = `
<div class="file-group-title">${folder}/</div>
${folderFiles.map(file => `
<div class="file-item" draggable="true" data-path="${file.webkitRelativePath}">
├── ${file.name}
</div>
`).join('')}
`;
fileList.appendChild(folderDiv);
}

processBtn.disabled = Object.keys(files).length === 0;
setupDragAndDrop();
});

function setupDragAndDrop() {
const items = document.querySelectorAll('.file-item');
items.forEach(item => {
item.addEventListener('dragstart', handleDragStart);
item.addEventListener('dragover', handleDragOver);
item.addEventListener('drop', handleDrop);
});
}

function handleDragStart(e) {
e.dataTransfer.setData('text/plain', e.target.dataset.path);
e.target.style.opacity = '0.5';
}

function handleDragOver(e) {
e.preventDefault();
}

function handleDrop(e) {
e.preventDefault();
const draggedPath = e.dataTransfer.getData('text/plain');
const droppedPath = e.target.dataset.path;

if (draggedPath && droppedPath) {
const draggedFolder = draggedPath.split('/')[0];
const droppedFolder = droppedPath.split('/')[0];

if (draggedFolder === droppedFolder) {
const draggedIndex = files[draggedFolder].findIndex(f => f.webkitRelativePath === draggedPath);
const droppedIndex = files[draggedFolder].findIndex(f => f.webkitRelativePath === droppedPath);

const temp = files[draggedFolder][draggedIndex];
files[draggedFolder][draggedIndex] = files[draggedFolder][droppedIndex];
files[draggedFolder][droppedIndex] = temp;

updateFileList();
}
}
}

function updateFileList() {
fileList.innerHTML = '';
for (const [folder, folderFiles] of Object.entries(files)) {
const folderDiv = document.createElement('div');
folderDiv.className = 'file-group';
folderDiv.innerHTML = `
<div class="file-group-title">${folder}/</div>
${folderFiles.map(file => `
<div class="file-item" draggable="true" data-path="${file.webkitRelativePath}">
├── ${file.name}
</div>
`).join('')}
`;
fileList.appendChild(folderDiv);
}
setupDragAndDrop();
}

async function processImages() {
const width = parseInt(widthInput.value);
const maxHeight = parseInt(heightInput.value);
const quality = parseInt(qualityInput.value) / 100;
const format = formatSelect.value;
const shouldMerge = mergeCheck.checked;

processBtn.disabled = true;
progressContainer.style.display = 'block';

for (const [folder, folderFiles] of Object.entries(files)) {
const zip = new JSZip();
let processedCount = 0;

if (shouldMerge) {
const images = await Promise.all(folderFiles.map(loadAndResizeImage));
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

let totalHeight = images.reduce((sum, img) => sum + img.height, 0);
let currentY = 0;
let currentPart = 1;

while (totalHeight > 0) {
const partHeight = Math.min(maxHeight, totalHeight);
canvas.width = width;
canvas.height = partHeight;
ctx.clearRect(0, 0, width, partHeight);

for (const img of images) {
const remainingHeight = img.height - currentY;
if (remainingHeight <= 0) continue;

const heightToDraw = Math.min(remainingHeight, partHeight);
ctx.drawImage(img, 0, currentY, width, heightToDraw, 0, 0, width, heightToDraw);
currentY += heightToDraw;
}

const blob = await new Promise(resolve => {
canvas.toBlob(resolve, `image/${format}`, quality);
});

zip.file(`${folder}_${String(currentPart).padStart(3, '0')}.${format}`, blob);
currentPart++;
totalHeight -= partHeight;

processedCount++;
updateProgress(processedCount, folderFiles.length);
}
} else {
for (const file of folderFiles) {
const img = await loadAndResizeImage(file);
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

canvas.width = width;
canvas.height = Math.round(width * img.height / img.width);
ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

const blob = await new Promise(resolve => {
canvas.toBlob(resolve, `image/${format}`, quality);
});

zip.file(`${file.name.split('.')[0]}.${format}`, blob);

processedCount++;
updateProgress(processedCount, folderFiles.length);
}
}

const zipBlob = await zip.generateAsync({type: 'blob'});
saveAs(zipBlob, `${folder}.zip`);
}

processBtn.disabled = false;
progressContainer.style.display = 'none';
}

function loadAndResizeImage(file) {
return new Promise((resolve) => {
const img = new Image();
img.onload = () => {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
const width = parseInt(widthInput.value);
const height = Math.round(width * img.height / img.width);

canvas.width = width;
canvas.height = height;
ctx.drawImage(img, 0, 0, width, height);

const resizedImg = new Image();
resizedImg.onload = () => resolve(resizedImg);
resizedImg.src = canvas.toDataURL();
};
img.src = URL.createObjectURL(file);
});
}

function updateProgress(current, total) {
const percentage = Math.round((current / total) * 100);
progressBar.style.width = `${percentage}%`;
progressText.textContent = `${percentage}%`;
}

processBtn.addEventListener('click', processImages);
</script>
</body>
</html>
