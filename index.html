<!DOCTYPE html><html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پردازشگر تصویر</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root {
--primary: #2563eb;
--primary-hover: #1d4ed8;
--bg: #f8fafc;
--border: #e2e8f0;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: system-ui, -apple-system, sans-serif;
}

body {
background: var(--bg);
padding: 2rem;
min-height: 100vh;
}

.container {
max-width: 800px;
margin: 0 auto;
background: white;
padding: 2rem;
border-radius: 1rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.form-group {
margin-bottom: 1.5rem;
}

label {
display: block;
margin-bottom: 0.5rem;
font-weight: 500;
}

input[type="number"],
input[type="range"],
select {
width: 100%;
padding: 0.5rem;
border: 1px solid var(--border);
border-radius: 0.5rem;
font-size: 1rem;
}

button {
background: var(--primary);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 0.5rem;
font-weight: 500;
cursor: pointer;
width: 100%;
font-size: 1rem;
}

button:hover {
background: var(--primary-hover);
}

button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.file-list {
border: 1px solid var(--border);
border-radius: 0.5rem;
padding: 1rem;
margin-top: 1rem;
max-height: 300px;
overflow-y: auto;
}

.progress {
margin-top: 1rem;
height: 0.5rem;
background: var(--border);
border-radius: 0.25rem;
overflow: hidden;
display: none;
}

.progress-bar {
height: 100%;
background: var(--primary);
width: 0;
transition: width 0.3s ease;
}

.status {
margin-top: 1rem;
text-align: center;
color: #666;
}
</style>
</head>
<body>
<div class="container">
<div class="form-group">
<label>انتخاب فایل‌ها</label>
<input type="file" id="fileInput" webkitdirectory directory multiple>
</div>

<div class="file-list" id="fileList"></div>

<div class="form-group">
<label>عرض (پیکسل)</label>
<input type="number" id="widthInput" value="800" min="1" max="10000">
</div>

<div class="form-group">
<label>حداکثر طول (پیکسل)</label>
<input type="number" id="maxHeightInput" value="14000" min="1" max="20000">
</div>

<div class="form-group">
<label>فرمت خروجی</label>
<select id="formatSelect">
<option value="webp">WebP</option>
<option value="jpeg">JPEG</option>
<option value="png">PNG</option>
</select>
</div>

<div class="form-group">
<label>کیفیت: <span id="qualityValue">100</span>%</label>
<input type="range" id="qualityInput" min="1" max="100" value="100">
</div>

<button id="processButton">شروع پردازش</button>

<div class="progress" id="progressBar">
<div class="progress-bar" id="progressBarFill"></div>
</div>

<div class="status" id="statusText"></div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const widthInput = document.getElementById('widthInput');
const maxHeightInput = document.getElementById('maxHeightInput');
const formatSelect = document.getElementById('formatSelect');
const qualityInput = document.getElementById('qualityInput');
const qualityValue = document.getElementById('qualityValue');
const processButton = document.getElementById('processButton');
const progressBar = document.getElementById('progressBar');
const progressBarFill = document.getElementById('progressBarFill');
const statusText = document.getElementById('statusText');

let files = new Map();

qualityInput.addEventListener('input', () => {
qualityValue.textContent = qualityInput.value;
});

fileInput.addEventListener('change', () => {
files.clear();
fileList.innerHTML = '';

Array.from(fileInput.files)
.filter(file => file.type.startsWith('image/'))
.sort((a, b) => a.name.localeCompare(b.name))
.forEach(file => {
const folderPath = file.webkitRelativePath.split('/')[0];
if (!files.has(folderPath)) {
files.set(folderPath, []);
}
files.get(folderPath).push(file);
});

updateFileList();
});

function updateFileList() {
    fileList.innerHTML = '';
    files.forEach((folderFiles, folderName) => {
        const folderDiv = document.createElement('div');
        folderDiv.style.marginBottom = '1.5rem';
        folderDiv.style.backgroundColor = '#f8f9fa';
        folderDiv.style.borderRadius = '8px';
        folderDiv.style.padding = '1rem';
        folderDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
        folderDiv.style.transition = 'all 0.3s ease';
        
        const folderNameDiv = document.createElement('div');
        folderNameDiv.innerHTML = `📁 ${folderName}/`;
        folderNameDiv.style.fontWeight = 'bold';
        folderNameDiv.style.marginBottom = '0.75rem';
        folderNameDiv.style.fontSize = '1.1rem';
        folderNameDiv.style.color = '#2563eb';
        folderNameDiv.style.borderBottom = '2px solid #e2e8f0';
        folderNameDiv.style.paddingBottom = '0.5rem';
        folderDiv.appendChild(folderNameDiv);
        
        const filesContainer = document.createElement('div');
        filesContainer.style.paddingLeft = '0.5rem';
        filesContainer.setAttribute('data-folder', folderName);
        
        folderFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.setAttribute('draggable', 'true');
            fileDiv.setAttribute('data-index', index);
            fileDiv.style.paddingLeft = '1.5rem';
            fileDiv.style.marginBottom = '0.4rem';
            fileDiv.style.position = 'relative';
            fileDiv.style.cursor = 'move';
            fileDiv.style.transition = 'all 0.2s ease';
            fileDiv.style.userSelect = 'none';
            
            // دکمه‌های جابجایی
            const moveButtons = document.createElement('div');
            moveButtons.style.display = 'inline-block';
            moveButtons.style.marginLeft = '10px';
            moveButtons.style.visibility = 'hidden';
            
            // فقط اگه اولین آیتم نباشه دکمه بالا نشون بده
            if (index > 0) {
                const upButton = document.createElement('button');
                upButton.innerHTML = '⬆️';
                upButton.style.border = 'none';
                upButton.style.background = 'none';
                upButton.style.cursor = 'pointer';
                upButton.style.padding = '0 2px';
                upButton.onclick = (e) => {
                    e.stopPropagation();
                    moveFile(folderName, index, index - 1);
                };
                moveButtons.appendChild(upButton);
            }
            
            // فقط اگه آخرین آیتم نباشه دکمه پایین نشون بده
            if (index < folderFiles.length - 1) {
                const downButton = document.createElement('button');
                downButton.innerHTML = '⬇️';
                downButton.style.border = 'none';
                downButton.style.background = 'none';
                downButton.style.cursor = 'pointer';
                downButton.style.padding = '0 2px';
                downButton.onclick = (e) => {
                    e.stopPropagation();
                    moveFile(folderName, index, index + 1);
                };
                moveButtons.appendChild(downButton);
            }
            
            if (index === folderFiles.length - 1) {
                fileDiv.innerHTML = `<span style="color: #94a3b8">└── </span>🖼 ${file.name}`;
            } else {
                fileDiv.innerHTML = `<span style="color: #94a3b8">├── </span>🖼 ${file.name}`;
            }
            
            fileDiv.appendChild(moveButtons);
            
            fileDiv.style.fontFamily = 'monospace';
            fileDiv.style.whiteSpace = 'pre';
            fileDiv.style.fontSize = '0.95rem';
            fileDiv.style.color = '#475569';
            
            fileDiv.addEventListener('mouseover', () => {
                fileDiv.style.color = '#2563eb';
                fileDiv.style.transform = 'translateX(5px)';
                moveButtons.style.visibility = 'visible';
            });
            
            fileDiv.addEventListener('mouseout', () => {
                fileDiv.style.color = '#475569';
                fileDiv.style.transform = 'translateX(0)';
                if (!fileDiv.classList.contains('dragging')) {
                    moveButtons.style.visibility = 'hidden';
                }
            });
            
            // Drag & Drop handlers
            fileDiv.addEventListener('dragstart', (e) => {
                fileDiv.classList.add('dragging');
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    folderName,
                    sourceIndex: index
                }));
            });
            
            fileDiv.addEventListener('dragend', () => {
                fileDiv.classList.remove('dragging');
                filesContainer.querySelectorAll('[data-index]').forEach(el => {
                    el.style.borderTop = 'none';
                    el.style.borderBottom = 'none';
                });
            });
            
            fileDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                const rect = fileDiv.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                if (e.clientY < mid) {
                    fileDiv.style.borderTop = '2px solid #2563eb';
                    fileDiv.style.borderBottom = 'none';
                } else {
                    fileDiv.style.borderBottom = '2px solid #2563eb';
                    fileDiv.style.borderTop = 'none';
                }
            });
            
            fileDiv.addEventListener('dragleave', () => {
                fileDiv.style.borderTop = 'none';
                fileDiv.style.borderBottom = 'none';
            });
            
            fileDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.folderName === folderName) {
                    const rect = fileDiv.getBoundingClientRect();
                    const mid = rect.top + rect.height / 2;
                    const targetIndex = e.clientY < mid ? index : index + 1;
                    moveFile(folderName, data.sourceIndex, targetIndex);
                }
            });
            
            filesContainer.appendChild(fileDiv);
        });
        
        folderDiv.appendChild(filesContainer);
        fileList.appendChild(folderDiv);
    });
}

// تابع جابجایی فایل‌ها
function moveFile(folderName, sourceIndex, targetIndex) {
    const folderFiles = files.get(folderName);
    if (sourceIndex === targetIndex) return;
    
    const [movedFile] = folderFiles.splice(sourceIndex, 1);
    folderFiles.splice(targetIndex, 0, movedFile);
    files.set(folderName, folderFiles);
    updateFileList();
}



function loadImage(file) {
return new Promise((resolve, reject) => {
const img = new Image();
const loadTimeout = setTimeout(() => {
img.src = '';
reject(new Error('تایم لود عکس تموم شد'));
}, 30000);

img.onload = () => {
clearTimeout(loadTimeout);
resolve(img);
URL.revokeObjectURL(img.src);
};

img.onerror = () => {
clearTimeout(loadTimeout);
reject(new Error(`لود نشد: ${file.name}`));
URL.revokeObjectURL(img.src);
};

img.src = URL.createObjectURL(file);
});
}

async function resizeImage(img, targetWidth) {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

const aspectRatio = img.width / img.height;
const newHeight = Math.round(targetWidth / aspectRatio);

canvas.width = targetWidth;
canvas.height = newHeight;

ctx.drawImage(img, 0, 0, targetWidth, newHeight);
return canvas;
}

async function processImages() {
if (files.size === 0) {
alert('لطفاً ابتدا فایل‌ها را انتخاب کنید.');
return;
}

const width = parseInt(widthInput.value);
const maxHeight = parseInt(maxHeightInput.value);
const quality = parseInt(qualityInput.value) / 100;
const format = formatSelect.value;

if (width <= 0 || width > 10000) {
alert('عرض باید بین 1 تا 10000 پیکسل باشد.');
return;
}

if (maxHeight <= 0 || maxHeight > 20000) {
alert('حداکثر طول باید بین 1 تا 20000 پیکسل باشد.');
return;
}

progressBar.style.display = 'block';
processButton.disabled = true;

try {
for (const [folderName, folderFiles] of files) {
statusText.textContent = `در حال پردازش پوشه: ${folderName}`;

// Step 1 & 2: Resize images and calculate total height
const resizedImages = [];
let totalHeight = 0;

for (let i = 0; i < folderFiles.length; i++) {
const progress = (i / folderFiles.length) * 0.4;
updateProgress(progress);
statusText.textContent = `در حال تغییر اندازه تصویر ${i + 1} از ${folderFiles.length}`;

const img = await loadImage(folderFiles[i]);
const resizedCanvas = await resizeImage(img, width);
resizedImages.push(resizedCanvas);
totalHeight += resizedCanvas.height;
}

// Step 3 & 4: Calculate number of output images
const numFullSections = Math.floor(totalHeight / maxHeight);
const remainingHeight = totalHeight % maxHeight;

// Step 5 & 6: Create and save sections
const zip = new JSZip();
let currentY = 0;

// Process full sections
for (let section = 0; section < numFullSections; section++) {
const progress = 0.4 + (section / numFullSections) * 0.6;
updateProgress(progress);
statusText.textContent = `در حال ایجاد بخش ${section + 1} از ${numFullSections + (remainingHeight > 0 ? 1 : 0)}`;

const sectionCanvas = document.createElement('canvas');
sectionCanvas.width = width;
sectionCanvas.height = maxHeight;
const ctx = sectionCanvas.getContext('2d');

let drawY = 0;
let processedHeight = 0;

for (const canvas of resizedImages) {
const sourceY = Math.max(0, currentY - processedHeight);
if (sourceY < canvas.height) {
const drawHeight = Math.min(maxHeight - drawY, canvas.height - sourceY);
if (drawHeight > 0) {
ctx.drawImage(
canvas,
0, sourceY, width, drawHeight,
0, drawY, width, drawHeight
);
drawY += drawHeight;
}
}
processedHeight += canvas.height;
}

const sectionNumber = String(section + 1).padStart(3, '0');
const blob = await new Promise(resolve => {
sectionCanvas.toBlob(resolve, `image/${format}`, quality);
});
zip.file(`${sectionNumber}.${format}`, blob);

currentY += maxHeight;
}

// Process remaining height if any
if (remainingHeight > 0) {
statusText.textContent = `در حال ایجاد بخش نهایی`;
updateProgress(0.9);

const sectionCanvas = document.createElement('canvas');
sectionCanvas.width = width;
sectionCanvas.height = remainingHeight;
const ctx = sectionCanvas.getContext('2d');

let drawY = 0;
let processedHeight = 0;

for (const canvas of resizedImages) {
const sourceY = Math.max(0, currentY - processedHeight);
if (sourceY < canvas.height) {
const drawHeight = Math.min(remainingHeight - drawY, canvas.height - sourceY);
if (drawHeight > 0) {
ctx.drawImage(
canvas,
0, sourceY, width, drawHeight,
0, drawY, width, drawHeight
);
drawY += drawHeight;
}
}
processedHeight += canvas.height;
}

const sectionNumber = String(numFullSections + 1).padStart(3, '0');
const blob = await new Promise(resolve => {
sectionCanvas.toBlob(resolve, `image/${format}`, quality);
});
zip.file(`${sectionNumber}.${format}`, blob);
}

// Clean up
resizedImages.forEach(canvas => {
canvas.width = 0;
canvas.height = 0;
});

// Save zip file
statusText.textContent = 'در حال ایجاد فایل زیپ...';
updateProgress(1);
const zipBlob = await zip.generateAsync({ type: 'blob' });
downloadBlob(zipBlob, `${folderName}.zip`);
}

statusText.textContent = 'پردازش با موفقیت انجام شد!';
} catch (error) {
console.error('Error:', error);
statusText.textContent = 'خطا در پردازش تصاویر';
alert('خطا در پردازش تصاویر: ' + error.message);
}

progressBar.style.display = 'none';
processButton.disabled = false;
}

function updateProgress(ratio) {
progressBarFill.style.width = `${ratio * 100}%`;
}

function downloadBlob(blob, fileName) {
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = fileName;
link.click();
URL.revokeObjectURL(link.href);
}

processButton.addEventListener('click', processImages);
</script>
</body>
</html>
