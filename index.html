<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پردازشگر تصویر</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<style>
:root {
--primary: #3b82f6;
--primary-hover: #2563eb;
--bg-dark: #1a1a1a;
--text-dark: #e5e5e5;
--border-dark: #333;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: system-ui, -apple-system, sans-serif;
}

body {
background: var(--bg-dark);
color: var(--text-dark);
padding: 2rem;
min-height: 100vh;
}

.container {
max-width: 800px;
margin: 0 auto;
background: #242424;
padding: 2rem;
border-radius: 1rem;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
}

.form-group {
margin-bottom: 1.5rem;
}

label {
display: block;
margin-bottom: 0.5rem;
font-weight: 500;
}

input[type="number"],
input[type="range"],
select {
width: 100%;
padding: 0.5rem;
background: #333;
border: 1px solid var(--border-dark);
color: var(--text-dark);
border-radius: 0.5rem;
font-size: 1rem;
}

button {
background: var(--primary);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 0.5rem;
font-weight: 500;
cursor: pointer;
width: 100%;
font-size: 1rem;
}

button:hover {
background: var(--primary-hover);
}

button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.folders-container {
margin-top: 1rem;
}

.folder {
background: #333;
border-radius: 0.5rem;
padding: 1rem;
margin-bottom: 1rem;
}

.folder-name {
font-weight: bold;
margin-bottom: 0.5rem;
color: var(--primary);
}

.file-tree {
padding-left: 1.5rem;
list-style: none;
}

.file-item {
margin: 0.25rem 0;
padding: 0.5rem;
background: #3a3a3a;
border-radius: 0.25rem;
cursor: move;
}

.file-item::before {
content: "├── ";
color: #666;
}

.file-item:last-child::before {
content: "└── ";
}

.progress-container {
margin-top: 1rem;
position: relative;
}

.progress {
height: 0.5rem;
background: #333;
border-radius: 1rem;
overflow: hidden;
}

.progress-bar {
height: 100%;
background: linear-gradient(90deg, var(--primary), #60a5fa);
width: 0;
transition: width 0.3s ease;
position: relative;
overflow: hidden;
}

.progress-bar::after {
content: "";
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(
90deg,
transparent,
rgba(255, 255, 255, 0.2),
transparent
);
animation: shine 1.5s infinite;
}

@keyframes shine {
0% { transform: translateX(-100%); }
100% { transform: translateX(100%); }
}

.status {
margin-top: 1rem;
text-align: center;
color: #888;
}
</style>
</head>
<body>

<div class="container">
<div class="form-group">
<label>انتخاب پوشه‌ها</label>
<input type="file" id="fileInput" webkitdirectory directory multiple>
</div>

<div class="folders-container" id="foldersContainer"></div>

<div class="form-group">
<label>عرض (پیکسل)</label>
<input type="number" id="widthInput" value="800" min="1" max="10000">
</div>

<div class="form-group">
<label>حداکثر طول (پیکسل)</label>
<input type="number" id="maxHeightInput" value="14000" min="1" max="20000">
</div>

<div class="form-group">
<label>فرمت خروجی</label>
<select id="formatSelect">
<option value="webp">WebP</option>
<option value="jpeg">JPEG</option>
<option value="png">PNG</option>
</select>
</div>

<div class="form-group">
<label>کیفیت: <span id="qualityValue">100</span>%</label>
<input type="range" id="qualityInput" min="1" max="100" value="100">
</div>

<button id="processButton">شروع پردازش</button>

<div class="progress-container">
<div class="progress" id="progressBar">
<div class="progress-bar" id="progressBarFill"></div>
</div>
<div class="status" id="statusText"></div>
</div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const foldersContainer = document.getElementById('foldersContainer');
const widthInput = document.getElementById('widthInput');
const maxHeightInput = document.getElementById('maxHeightInput');
const formatSelect = document.getElementById('formatSelect');
const qualityInput = document.getElementById('qualityInput');
const qualityValue = document.getElementById('qualityValue');
const processButton = document.getElementById('processButton');
const progressBar = document.getElementById('progressBar');
const progressBarFill = document.getElementById('progressBarFill');
const statusText = document.getElementById('statusText');

let folders = new Map();

qualityInput.addEventListener('input', () => {
qualityValue.textContent = qualityInput.value;
});

fileInput.addEventListener('change', () => {
folders.clear();
foldersContainer.innerHTML = '';

Array.from(fileInput.files)
.filter(file => file.type.startsWith('image/'))
.forEach(file => {
const [folderPath, ...filePath] = file.webkitRelativePath.split('/');
if (!folders.has(folderPath)) {
folders.set(folderPath, []);
}
folders.get(folderPath).push(file);
});

updateFolderList();
});

function updateFolderList() {
foldersContainer.innerHTML = '';

folders.forEach((files, folderName) => {
const folderDiv = document.createElement('div');
folderDiv.className = 'folder';

const folderNameDiv = document.createElement('div');
folderNameDiv.className = 'folder-name';
folderNameDiv.textContent = `${folderName}/`;

const fileList = document.createElement('ul');
fileList.className = 'file-tree';

files.sort((a, b) => a.name.localeCompare(b.name))
.forEach(file => {
const li = document.createElement('li');
li.className = 'file-item';
li.textContent = file.name;
li.dataset.path = file.webkitRelativePath;
fileList.appendChild(li);
});

folderDiv.appendChild(folderNameDiv);
folderDiv.appendChild(fileList);
foldersContainer.appendChild(folderDiv);

new Sortable(fileList, {
animation: 150,
onSort: (evt) => {
const folderFiles = folders.get(folderName);
const movedFile = folderFiles.find(f => f.webkitRelativePath === evt.item.dataset.path);
folderFiles.splice(evt.oldIndex, 1);
folderFiles.splice(evt.newIndex, 0, movedFile);
}
});
});
}

function loadImage(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = (e) => {
const img = new Image();
img.onload = () => resolve(img);
img.onerror = reject;
img.src = e.target.result;
};
reader.onerror = reject;
reader.readAsDataURL(file);
});
}

function resizeImage(img, targetWidth, maxHeight) {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

let width = targetWidth;
let height = (img.height * width) / img.width;

if (height > maxHeight) {
height = maxHeight;
width = (img.width * height) / img.height;
}

canvas.width = width;
canvas.height = height;
ctx.drawImage(img, 0, 0, width, height);
return canvas;
}

async function processImages() {
if (folders.size === 0) {
alert('لطفا ابتدا پوشه‌ها را انتخاب کنید');
return;
}

processButton.disabled = true;
progressBar.style.display = 'block';
let processed = 0;
const totalImages = Array.from(folders.values()).flat().length;

const zip = new JSZip();
const width = parseInt(widthInput.value);
const maxHeight = parseInt(maxHeightInput.value);
const format = formatSelect.value;
const quality = parseInt(qualityInput.value) / 100;

for (const [folderName, files] of folders) {
const folderZip = zip.folder(folderName);

for (const file of files) {
try {
const img = await loadImage(file);
const canvas = resizeImage(img, width, maxHeight);

const blob = await new Promise(resolve => {
canvas.toBlob(resolve, `image/${format}`, quality);
});

folderZip.file(file.name.replace(/\.[^.]+$/, `.${format}`), blob);

processed++;
updateProgress(processed / totalImages);
} catch (error) {
console.error(`Error processing ${file.name}:`, error);
}
}
}

const zipBlob = await zip.generateAsync({type: 'blob'});
downloadBlob(zipBlob, 'processed_images.zip');

processButton.disabled = false;
}

function updateProgress(progress) {
progressBarFill.style.width = `${progress * 100}%`;
statusText.textContent = `پردازش ${Math.round(progress * 100)}%`;
}

function downloadBlob(blob, filename) {
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

processButton.addEventListener('click', processImages);
</script>

</body>
</html>
